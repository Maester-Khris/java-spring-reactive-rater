<!DOCTYPE html>
<html lang="en" xmlns:th="www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" th:href="@{/img/favicon.ico}" type="image/x-icon">
    <meta th:csrf="${_csrf.token}">
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <title>Rating page</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
        integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.dataTables.min.css">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link rel="stylesheet" type='text/css' href="https://cdn.jsdelivr.net/gh/devicons/devicon@latest/devicon.min.css" />
    <link rel="stylesheet" th:href="@{/css/app.css}">
    <style>
        .tool-score-stars i {
            color: gold;
        }
        .ranked-skill-item[data-dirty="true"] {
            border-left: 4px solid #cc0000;
        }
    </style>
</head>

<body style="background-color: beige;height: 100vh;width: 100%;">
    <div class="wrapper">
        <section class="hero-section">
            <div class="hero-content">
                <h1 class="hero-title">Discover & Rank Your Skills</h1>
                <p class="hero-subtitle">
                    Personalize your tech stack. Rate your proficiency, organize your favorites, and track your growth.
                </p>
                <div class="hero-actions" th:switch="${isUserAuthenticated}">
                    <!-- Case: Logged in -->
                    <form th:case="true" th:action="@{/logout}" method="post" class="d-inline">
                        <button type="submit" class="btn btn-primary hero-btn btn-info auth-btn"
                            style="background-color: #c17e7e;border-color: #c17e7e;">
                            <i class="ph-bold ph-user" style="font-size:18px;margin-right: 3px;"></i>
                            <span sec:authentication="name"></span>, Logout
                        </button>
                    </form>
                    <!-- Always visible link -->
                    <a href="/votes" class="btn btn-secondary hero-btn">
                        <i class="ph-bold ph-ranking" style="font-size:18px;margin-right: 3px;"></i> Explore Public
                        Ranks
                    </a>
                </div>
            </div>
        </section>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb" style="position: relative;">
                <li class="breadcrumb-item"><a href="/"><i class="ph-fill ph-house-line"></i> Home</a></li>
                <li class="breadcrumb-item"><a href="/votes"><i class="ph-fill ph-sparkle"></i>Skill stats</a></li>
                <li class="breadcrumb-item active" aria-current="page"><a href="/myratings"><i
                            class="ph-fill ph-pencil-ruler"></i>Skills rating</a></li>
                <li class="breadcrumb-item"><a href="/swagger-ui.html" target="_blank"
                        style="position:absolute;right:10px;"><i class="ph-fill ph-arrow-square-out"></i>API
                        documentation</a></li>
            </ol>
        </nav>
        <section class="personal-ranking-container">
            <div class="skill-section-header">
                <h3>
                    My Personal Ranking
                </h3>
                <div class="title-border"></div>
            </div>
            <p class="leading">
                Lorem ipsum dolor sit amet consectetur, adipisicing elit. Pariatur animi repellat,
                nihil obcaecati laboriosam repellendus! Magni a dolores ratione aliquid corporis rem placeat
                maxime similique delectus.
            </p>
            <div class="ranking-split-view">
                <!-- LEFT SIDE: Ranked Tools -->
                <div class="my-ranked-tools w-70 position-relative">
                    <div class="ranking-header ranking-header-plus">
                        <span class="header-rank" style="padding-left: 10px;">RANK</span>
                        <span class="header-tool">TOOL</span>
                        <span class="header-score" style="text-align: left;">SCORE</span>
                        <span class="header-remove" style="text-align: center;">REMOVE</span>
                    </div>
                    <ul id="personalRankedList" class="ranked-list">
                        <li th:each="skill, iterStat : ${userRatedList}"
                            th:attr="data-skill-uuid=${skill.skilluuid}, data-rank=${iterStat.index + 1}, data-dirty='false'"
                            class="ranked-item">
                            <!-- Rank input -->
                            <span class="rank-control" style="padding-left: 10px;">
                                <input type="number" min="0" th:value="${skill.rating}" class="rank-input">
                            </span>
                            <!-- Tool icon and name -->
                            <div class="tool-info-content" style="display:flex; align-items:center;">
                                <i th:class="${skill.skillicon} + ' colored tool-icon'"
                                   style="font-size:25px; margin-right:10px;"></i>
                                <span class="tool-name" th:text="${skill.skillname}"></span>
                            </div>
                            <!-- Stars rating -->
                            <div class="tool-score-stars" th:attr="data-rating=${skill.proficiency}"
                                 th:text="${'⭐'.repeat(skill.proficiency)}"></div>
                            <!-- Remove button -->
                            <button th:if="${isUserAuthenticated}" class="px-3 py-.5 btn-remove-rank"
                                    title="Remove from rank" th:attr="data-skill-uuid=${skill.skilluuid}">
                                <i class="ph ph-x"></i>
                            </button>
                        </li>
                    </ul>
                    <!-- Bulk save button -->
                    <div class="d-none rank-bulk-update position-absolute" style="bottom: 8px;left: 0px;margin: 0px 10px;display:flex;flex-direction: row; justify-content:flex-end; width: 96%;">
                         <span id="saveFeedback" class="d-none save-feedback" style="font-weight: bold; padding: 6px 12px;">
                            <i class="ph ph-check" style="font-size: 23px; color: #0d6efd;"></i> Saved
                        </span>
                        <button id="saveAllRankedBtn" class="btn btn-primary">Save All Ratings</button>
                    </div>
                </div>

                <!-- RIGHT SIDE: Available Tools Drawer -->
                <div class="available-tools-drawer w-30">
                    <h4 class="drawer-title mt-2" style="font-size:18px; font-weight:bold; text-transform:uppercase;">
                        Find & Add Tools
                    </h4>
                    <div class="drawer-search">
                        <i class="ph ph-magnifying-glass"></i>
                        <input type="text" id="toolSearchInput" placeholder="Search tools..."
                            aria-label="Search available tools">
                    </div>
                    <ul id="unrankedToolsList" class="unranked-list">
                        <li th:each="skill : ${systemSkillList}" th:attr="data-skill-uuid=${skill.skilluuid}">
                            <div>
                                <i th:class="${skill.skillicon} + ' colored tool-icon'"></i>
                                <span class="tool-name" style="text-transform:capitalize;"
                                      th:text="${skill.skillname.length() > 6 ? #strings.substring(skill.skillname, 0, 6) + '...' : skill.skillname}"></span>
                            </div>
                            <button th:if="${skill.rated==false}" class="btn btn-success btn-add-rank"
                                th:attr="data-skill-uuid=${skill.skilluuid}">
                                + Rank
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </section>

        <form action="#" th:action="@{/skill-rate-update}" id="skill-rater" method="post">
            <input type="number" min="1" max="5" value="">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <button type="submit">Submit</button>
        </form>
    </div>
    <div id="back-to-top" class="d-flex justify-content-center align-items-center">
        <i class="ph-bold ph-caret-double-up"></i>
    </div>

    <template id="skillItemTemplate">
        <li class="ranked-skill-item" data-skill-uuid="" data-rank="">
            <!-- Rank input -->
            <span class="rank-control" style="padding-left: 10px;">
                <input type="number" min="1" value="0" class="rank-input">
            </span>
            <!-- Tool icon and name -->
            <div class="tool-info-content" style="display:flex; align-items:center;">
                <i class="skill-icon" style="font-size:25px; margin-right:10px;"></i>
                <span class="tool-name"></span>
            </div>
            <!-- Stars rating -->
            <div class="tool-score-stars" data-rating="0" style="display:flex; gap:3px; cursor:pointer;">
                <i class="ph-fill ph-star h6" data-value="1"></i>
                <i class="ph ph-star h6" data-value="2"></i>
                <i class="ph ph-star h6" data-value="3"></i>
                <i class="ph ph-star h6" data-value="4"></i>
                <i class="ph ph-star h6" data-value="5"></i>
            </div>
            <!-- Remove button -->
            <button class="px-3 py-.5 btn-remove-rank" title="Remove from rank" data-skill-uuid="">
                <i class="ph ph-x"></i>
            </button>
        </li>
    </template>

    <script th:src="@{/js/backtotop.js}"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.datatables.net/2.1.8/js/dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
    <script th:inline="javascript">
        const loggedUserId = [[${userId}]];
    </script>
    <script>
        function updateStars(container, value) {
            container.querySelectorAll('i').forEach(s => {
                if (parseInt(s.dataset.value) <= value) {
                    s.classList.remove('ph');
                    s.classList.add('ph-fill');
                } else {
                    s.classList.remove('ph-fill');
                    s.classList.add('ph');
                }
                s.classList.add('ph-star');
            });
        }

        function getCookie(name) {
          return document.cookie.split('; ')
            .find(row => row.startsWith(name + '='))
            ?.split('=')[1];
        }


       document.addEventListener("DOMContentLoaded", function () {
           const personalList = document.getElementById("personalRankedList");
            const rankbtns = document.querySelectorAll(".btn-add-rank");
            const searchInput = document.getElementById("toolSearchInput");
            const toolList = document.getElementById("unrankedToolsList");
            const allItems = Array.from(toolList.querySelectorAll("li"));
            const bulkUpdateDiv = document.querySelector(".rank-bulk-update");

            rankbtns.forEach(btn => {
                btn.addEventListener("click", () => {
                const skillUuid = btn.dataset.skillUuid;
                const skillItem = btn.closest("li");
                const skillName = skillItem.querySelector(".tool-name").textContent;
                const skillIconClass = skillItem.querySelector("i").className;

                // Check if skill already exists in ranked list
                if (personalList.querySelector(`li[data-skill-uuid='${skillUuid}']`)) {
                    console.log("Skill already in ranked list");
                    return;
                }

                // Clone template
                const template = document.getElementById("skillItemTemplate");
                const newLi = template.content.cloneNode(true).querySelector("li");

                // Set attributes
                newLi.dataset.skillUuid = skillUuid;
                newLi.dataset.rank = personalList.children.length + 1;
                newLi.dataset.dirty = "true"; 
                newLi.querySelector(".tool-name").textContent = skillName;
                newLi.querySelector(".skill-icon").className = skillIconClass;
                newLi.querySelector(".btn-remove-rank").dataset.skillUuid = skillUuid;

                // Rating input change
                newLi.querySelector(".rank-input").addEventListener("input", () => {
                    newLi.dataset.dirty = "true";
                });

                // Attach hover & click logic to stars
                const stars = newLi.querySelectorAll('.tool-score-stars i');
                const starContainer = newLi.querySelector('.tool-score-stars');

                stars.forEach(star => {
                    // Hover effect
                    star.addEventListener('mouseenter', () => {
                        const hoverValue = parseInt(star.dataset.value);
                        updateStars(starContainer, hoverValue);
                    });

                    // Reset to saved rating when mouse leaves
                    starContainer.addEventListener('mouseleave', () => {
                        const currentRating = parseInt(starContainer.dataset.rating) || 0;
                        updateStars(starContainer, currentRating);
                    });

                    // Click to permanently set rating
                    star.addEventListener('click', () => {
                        const clickedValue = parseInt(star.dataset.value);
                        starContainer.dataset.rating = clickedValue;
                        updateStars(starContainer, clickedValue);
                        newLi.dataset.dirty = "true"; // mark element as changed
                        console.log(`Set proficiency rating: ${clickedValue}`);
                    });
                });
                
                // Append to personal ranked list
                personalList.appendChild(newLi);

                // Optional: update UI (disable +Rank button, etc.)
                btn.disabled = true;
                btn.textContent = "Ranked";
                bulkUpdateDiv.classList.contains("d-none") && bulkUpdateDiv.classList.remove("d-none");
                });
            });

            // Handle click on the "Save All Ratings" button
            document.getElementById('saveAllRankedBtn').addEventListener('click', () => {
                const rankedList = document.querySelectorAll('#personalRankedList li');
                const skillData = [];

                rankedList.forEach(li => {
                    const isDirty = li.dataset.dirty === "true";
                    if (!isDirty) return; // skip unchanged items

                    const skillUuid = li.querySelector('.btn-remove-rank')?.dataset.skillUuid;
                    const rating = parseInt(li.querySelector('.rank-input')?.value || 0);
                    const starsContainer = li.querySelector('.tool-score-stars');
                    const proficiency = parseInt(starsContainer?.dataset.rating || 0);

                    if (rating > 0 || proficiency > 0) {
                        skillData.push({
                            skilluuid: skillUuid || null,
                            rating,
                            proficiency
                        });
                    }
                });

                if (skillData.length === 0) {
                    alert("No valid skills to save. Please rate or set proficiency first.");
                    return;
                }

                console.log("Skills to save:", skillData);
                const csrfToken = getCookie('XSRF-TOKEN');
                fetch(`http://localhost:8080/api/v1/data/users/${loggedUserId}/rating-update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(skillData)
                })
                //.then(r => r.json())
                  .then(res => {
                      document.getElementById('saveFeedback').classList.remove('d-none');
                      document.getElementById('saveFeedback').classList.add('d-inline-block');
                      setTimeout(() => document.getElementById('saveFeedback').classList.add('d-none'), 1500);
                      // remove dirty flags
                      rankedList.forEach(li => li.dataset.dirty = "false");
                      bulkUpdateDiv.classList.add("d-none");
                  });
            });

            searchInput.addEventListener("input", () => {
                const query = searchInput.value.trim().toLowerCase();
                // Clear current list
                toolList.innerHTML = "";
                // Filter and repopulate
                const filteredItems = allItems.filter(li => {
                    const toolName = li.querySelector(".tool-name").textContent.toLowerCase();
                    return toolName.includes(query);
                });
                filteredItems.forEach(li => toolList.appendChild(li));
                // Optional: show a "No results" message if filteredItems is empty
                if (filteredItems.length === 0) {
                    const li = document.createElement("li");
                    li.textContent = "No tools found";
                    li.classList.add("no-results");
                    toolList.appendChild(li);
                }
            });
        });

        //=== this code is verified and works, has been commented for client side testing
        //startEventSource();
        //let form = document.querySelector("#rating-form");
        /**
        *  form.addEventListener("submit",function(e){
            e.preventDefault();
            console.log("what...");
            let formdata = new FormData(e.target);
                try{
                    axios.post("/post-rating",{
                    "skilluuid":formdata.get("skill"),
                    "rating":formdata.get("rating")
                    }).then(function(res){
                        console.log(res.data);
                    });
            }catch(e){
                console.log("following error rose ",e);
            }
        });
        */
    </script>
</body>

</html>